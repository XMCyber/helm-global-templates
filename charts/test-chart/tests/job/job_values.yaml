global:
  render_key: rendered

jobs:
  migration-job:
    name: db-migration
    namespace: test-namespace
    backoffLimit: 3
    activeDeadlineSeconds: 3600
    ttlSecondsAfterFinished: 300
    completions: 1
    parallelism: 1
    completionMode: NonIndexed
    restartPolicy: Never
    initContainers:
      - name: wait-for-db
        image:
          registry: docker.io
          repository: busybox
          tag: 1.35.0
        command:
          - /bin/sh
          - -c
          - "until nc -z db-host 5432; do sleep 2; done"
        resources:
          requests:
            cpu: 50m
            memory: 64Mi
    containers:
      - name: migration
        image:
          registry: docker.io
          repository: my-org/migration
          tag: 2.0.0
        command:
          - /bin/sh
          - -c
          - "run-migration.sh"
        args:
          - "--migrate"
          - "--verbose"
        env:
          DB_HOST: "db.example.com"
          LOG_LEVEL: "INFO"
        envFrom:
          - configMapRef:
              name: migration-config
          - secretRef:
              name: migration-secret
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
        volumeMounts:
          data-volume:
            name: data-volume
            mountPath: /data/migration
    volumes:
      data-volume:
        name: data-volume
        configMap:
          name: migration-config
          items:
            - key: config.yaml
              path: config.yaml
    annotations:
      argocd.argoproj.io/hook: PreSync
    labels:
      app.kubernetes.io/component: "migration"
    podAnnotations:
      prometheus.io/scrape: "false"
    podLabels:
      job-type: "database-migration"
